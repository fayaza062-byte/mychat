<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Group Chat</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220aa;--glass:rgba(255,255,255,0.04);--accent:#7c3aed}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071026 0%, #081827 50%, #071026 100%);display:grid;place-items:center;padding:24px;color:#e6eef8}

    .app{width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6);overflow:hidden;display:grid;grid-template-columns:320px 1fr}

    /* Left panel */
    .sidebar{padding:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);backdrop-filter:blur(6px);border-right:1px solid rgba(255,255,255,0.02)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#2dd4bf);display:grid;place-items:center;font-weight:700;color:#071026}
    .title{font-weight:700;font-size:18px}
    .sub{font-size:12px;color:#bcd2ee;margin-top:4px}

    .users{margin-top:18px}
    .user-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;margin-bottom:8px;cursor:default}
    .avatar{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#a78bfa,#60a5fa);display:grid;place-items:center;font-weight:600;color:#051225}
    .you{border:1px solid rgba(255,255,255,0.03);}

    /* Chat panel */
    .chat{display:flex;flex-direction:column;height:640px;padding:20px;gap:12px}
    .messages{flex:1;overflow:auto;padding:6px 8px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));box-shadow:inset 0 1px 0 rgba(255,255,255,0.01)}
    .msg{max-width:70%;padding:10px 12px;border-radius:12px;margin-bottom:10px;line-height:1.2}
    .msg.me{margin-left:auto;background:linear-gradient(90deg,var(--accent),#06b6d4);color:#041022}
    .msg.other{background:var(--glass);color:#dfefff}
    .meta{font-size:12px;color:#9fb6d8;margin-top:6px}

    .composer{display:flex;gap:8px}
    .input{flex:1;display:flex;gap:8px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02)}
    .input input{flex:1;background:transparent;border:0;outline:0;color:inherit;font-size:15px}
    .btn{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#051225;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe5ff}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.8));display:grid;place-items:center}
    .modal{width:420px;background:linear-gradient(180deg,#071627, #081827);padding:22px;border-radius:14px;box-shadow:0 10px 40px rgba(2,6,23,0.7)}
    .modal h2{margin:0 0 6px 0}
    .modal p{margin:0 0 16px 0;color:#9fb6d8}
    .field{display:flex;gap:8px}
    .field input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

    /* helpers */
    .muted{color:#9fb6d8;font-size:13px}
    @media(max-width:820px){.app{grid-template-columns:1fr;max-width:680px}.sidebar{display:none}.chat{height:76vh}}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Open group chat">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">OG</div>
        <div>
          <div class="title">Open Group Chat</div>
          <div class="sub">Simple, stylish — just enter your name</div>
        </div>
      </div>

      <div class="users">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Active</strong>
          <button id="refreshUsers" class="btn secondary" style="padding:6px 8px;font-size:13px">Refresh</button>
        </div>
        <div id="usersList" aria-live="polite"></div>
      </div>

      <div style="margin-top:18px;font-size:13px;color:#9fb6d8">API endpoints used:<br><span class="muted">/api/users</span> &nbsp; <span class="muted">/api/messages</span></div>
    </aside>

    <main class="chat">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="headerName">Join the chat</strong>
          <div id="headerSub" class="muted">Be kind. Messages are public to everyone connected.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="changeNameBtn" class="btn secondary">Change name</button>
        </div>
      </div>

      <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

      <div class="composer">
        <div class="input" role="group" aria-label="message input">
          <input id="messageInput" placeholder="Write a message and press Enter..." autocomplete="off" />
          <div id="typing" class="muted" style="font-size:12px"></div>
        </div>
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </main>
  </div>

  <!-- name modal -->
  <div id="nameModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h2>What should we call you?</h2>
      <p>Enter a display name. This is a public open group — pick something friendly.</p>
      <div style="display:flex;gap:8px">
        <input id="nameInput" placeholder="Your name" />
        <button id="joinBtn" class="btn">Join</button>
      </div>
      <p style="margin-top:10px;font-size:13px;color:#9fb6d8">Tip: your name will be stored locally in this browser.</p>
    </div>
  </div>

  <script>
    // ========== Configuration ===========
    const API_BASE = 'https://losojk.com';
    const USERS_ENDPOINT = API_BASE + '/api/users';
    const MESSAGES_ENDPOINT = API_BASE + '/api/messages';
    const POLL_MS = 1500; // how often to fetch messages

    // ========== State ==========
    let me = { name: null, id: null };
    let messages = [];
    let pollHandle = null;

    // ========== DOM ==========
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('nameInput');
    const joinBtn = document.getElementById('joinBtn');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const headerName = document.getElementById('headerName');
    const headerSub = document.getElementById('headerSub');
    const usersList = document.getElementById('usersList');

    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const refreshUsersBtn = document.getElementById('refreshUsers');
    const typingEl = document.getElementById('typing');

    // ========== Helpers ==========
    function el(tag, cls, txt) { const e = document.createElement(tag); if(cls) e.className = cls; if(txt) e.textContent = txt; return e }
    function nowISO(){ return new Date().toISOString() }

    function saveName(){ localStorage.setItem('og_name', me.name); if(me.id) localStorage.setItem('og_id', me.id) }
    function loadName(){ const name = localStorage.getItem('og_name'); const id = localStorage.getItem('og_id'); if(name){ me.name = name; me.id = id; return true } return false }

    // ========== API calls (assumptions) ==========
    // NOTE: The exact shape of your API may differ. If POST /api/users expects different fields
    // or returns a different structure, update the code in joinChat() accordingly.

    async function joinChat(name){
      me.name = name.trim();
      if(!me.name) return alert('Please enter a name');
      // Try registering user (best-effort). If your API does not require this, it's OK.
      try{
        const res = await fetch(USERS_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: me.name }) });
        if(res.ok){ const data = await res.json(); // expecting returned user object with id
          if(data && (data.id || data._id)) me.id = data.id || data._id;
        } else {
          // server may reject creation but we still allow chat locally
          console.warn('user create failed', res.status);
        }
      } catch(e){ console.warn('users endpoint unreachable', e) }

      saveName();
      hideNameModal();
      headerName.textContent = me.name;
      headerSub.textContent = 'You are in the open group chat — messages are public.';
      startPolling();
      fetchUsers();
    }

    async function fetchUsers(){
      try{
        const res = await fetch(USERS_ENDPOINT);
        if(!res.ok) throw new Error(res.status);
        const data = await res.json();
        renderUsers(Array.isArray(data)?data:[]);
      } catch(e){ console.warn('failed fetching users', e); usersList.innerHTML = '<div class="muted">Unable to load users</div>' }
    }

    function renderUsers(list){ usersList.innerHTML=''; if(!list.length){ usersList.innerHTML='<div class="muted">No users found</div>'; return }
      list.slice(0,30).forEach(u=>{
        const row = el('div','user-item');
        const av = el('div','avatar', (u.name||u.username||'User').slice(0,2).toUpperCase());
        if(me.name && (u.name||u.username)==me.name) av.classList.add('you');
        const nm = el('div', '', u.name || u.username || 'Anonymous');
        row.appendChild(av); row.appendChild(nm);
        usersList.appendChild(row);
      }) }

    async function fetchMessages(){
      try{
        const res = await fetch(MESSAGES_ENDPOINT);
        if(!res.ok) throw new Error(res.status);
        const data = await res.json();
        if(Array.isArray(data)){
          // naive dedupe by id or timestamp + text
          const keySet = new Set(messages.map(m=>m._id || (m.ts + '|' + m.text)));
          let changed = false;
          data.sort((a,b)=> new Date(a.ts||a.createdAt||a.time||a.date) - new Date(b.ts||b.createdAt||b.time||b.date));
          data.forEach(d=>{
            const key = d._id || (d.ts + '|' + d.text);
            if(!keySet.has(key)){ messages.push(d); keySet.add(key); changed = true }
          });
          if(changed) renderMessages();
        } else {
          console.warn('unexpected messages payload', data);
        }
      } catch(e){ console.warn('fetch msg error', e) }
    }

    function renderMessages(){ messagesEl.innerHTML = '';
      messages.slice(-200).forEach(m=>{
        const isMe = (me.name && (m.name||m.user||m.author)===me.name) || (me.id && (m.userId==me.id || m.user==me.id));
        const box = el('div','msg ' + (isMe? 'me':'other'));
        box.innerHTML = `<div style="font-weight:700;font-size:14px">${escapeHTML(m.name||m.user||m.author||'Anonymous')}</div>
                         <div style="margin-top:6px">${escapeHTML(m.text||m.message||m.body||'')}</div>
                         <div class="meta">${formatTime(m.ts||m.createdAt||m.time||m.date)}</div>`;
        messagesEl.appendChild(box);
      });
      // auto-scroll
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function formatTime(t){ if(!t) return ''; const d = new Date(t); if(isNaN(d)) return ''; return d.toLocaleString(); }
    function escapeHTML(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    async function sendMessage(text){ text = text.trim(); if(!text) return;
      const payload = { name: me.name, text, ts: nowISO(), userId: me.id };
      // optimistic UI
      const temp = { ...payload, _id: 't' + Date.now() };
      messages.push(temp); renderMessages();

      try{
        const res = await fetch(MESSAGES_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error(res.status);
        const saved = await res.json();
        // replace the temp message if server returned an id
        if(saved && (saved._id || saved.id)){
          const idx = messages.findIndex(m => m._id === temp._id);
          if(idx>-1){ messages[idx] = saved; renderMessages(); }
        }
      } catch(e){ console.warn('send failed', e); typingEl.textContent = 'Send failed — retrying'; setTimeout(()=>typingEl.textContent='',2000) }
    }

    function startPolling(){ if(pollHandle) clearInterval(pollHandle); fetchMessages(); pollHandle = setInterval(fetchMessages, POLL_MS) }
    function stopPolling(){ if(pollHandle) clearInterval(pollHandle); pollHandle = null }

    // ========== UI wiring ==========
    joinBtn.addEventListener('click', ()=> joinChat(nameInput.value) );
    nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') joinChat(nameInput.value) });
    changeNameBtn.addEventListener('click', ()=> showNameModal(true));

    messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ sendBtn.click(); } else { typingEl.textContent = 'typing...'; setTimeout(()=>typingEl.textContent='',700) } });
    sendBtn.addEventListener('click', async ()=>{ if(!me.name){ showNameModal(); return } const txt = messageInput.value; messageInput.value=''; await sendMessage(txt); });
    refreshUsersBtn.addEventListener('click', fetchUsers);

    function showNameModal(isChange){ nameModal.style.display='grid'; nameInput.value = me.name || ''; nameInput.focus(); }
    function hideNameModal(){ nameModal.style.display='none'; }

    // auto-init
    (function init(){ if(loadName()){ headerName.textContent = me.name; headerSub.textContent = 'Restoring your session…'; startPolling(); fetchUsers(); } else { showNameModal(); } })();

    // Clean shutdown when navigating away
    window.addEventListener('beforeunload', ()=>{ stopPolling(); });

    // optional: live-reload messages on focus
    window.addEventListener('focus', ()=> fetchMessages());

    // Accessibility hint: focus send button when user types
    messageInput.addEventListener('input', ()=>{ sendBtn.disabled = messageInput.value.trim().length===0 });
  </script>
</body>
</html>
